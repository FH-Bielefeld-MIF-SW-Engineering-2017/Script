## Storage 

![IoT-Sicherheitsarchitektur](/assets/img1_iot-hub.png)
[Quelle: http://download.microsoft.com/download/A/4/D/A4DAD253-BC21-41D3-B9D9-87D2AE6F0719/Microsoft_Azure_IoT_Reference_Architecture.pdf - Seite 4]

Die Speicherfrage auf eingebetteten System wie zum Beispiel Sensoren stellt immer eine große Herausforderung, weil der Sensor diese Daten meist selbst nicht braucht und um große Datenmengen vorzuhalten ist ein Speicher auf jedem Sensor meist zu teuer. Um  

### IOT-Storage 


Das Verständnis von Datenkonzepten ist ein wichtiger erster Schritt zum Aufbau von gerätezentrischen Datenerfassungs-, Analyse- und Steuerungssystemen. Dabei wird zwischen einem internetfähigen Gerät und einem nicht-internetfähigem Gerät unterschieden, welche sich dann jeweils in eine normale und eine Low-Power-Gruppe teilen. Die Internetfähigen Geräte besitzen ein Protokoll, über welches es direkt möglich ist mit dem Cloud-Gateway zu kommunizieren. Ein nicht-internetfähiges Gerät muss von einem Gateway unterstützt werden. Dieses Gateway kann über ein Kabel oder eine kabellose Schnittstelle wie Bluetooth mit dem Sensor kommunizieren, die Daten sammeln und an die Cloud weitergeben. 


Bei diesen Daten handelt es sich um die Telemetrie der Hardware. Dabei handelt es sich meist um Punkt-Beobachtungen, die über einen definierten Zeitraum gemacht wurden, der für das Signal als geeignet erachtet wird. Diese Signale können sogar von der Hardware vorverarbeitet werden, wie zum Beispiel die Integration über einen gewissen Zeitraum, werden jedoch danach immer Kodiert zu einem für die Sequenz passenden Format. Für Audiodaten bietet sich zum Beispiel das Codec MP3 an und Wetterdaten wie Temperatur, usw. das Codec TEMPS. 

![IoT-Sicherheitsarchitektur](/assets/img2_iot-hub.png)
[Quelle: http://download.microsoft.com/download/A/4/D/A4DAD253-BC21-41D3-B9D9-87D2AE6F0719/Microsoft_Azure_IoT_Reference_Architecture.pdf - Seite 9]

Eine Gerätebereitstellungs-API sorgt für das Erfassen neuer Geräte oder entfernen Alter. Ebenso kann die Gerätebereitstellung Sensoren aktivieren und deaktivieren. Wenn sie deaktiviert sind, haben sie keinen Zugriff auf das System, aber alle Zugriffsregeln, Schlüssel und Metadaten bleiben bestehen um eine leichtere Reaktivierung zu ermöglichen. Die Geräteidentität und Konfiguration speichert jedoch nicht das Gerät selbst sondern der Gerätebereitstellungsdienst. Das Provisioning bietet jedoch keinem externen Gerät die Möglichkeit etwas an dem Gerätebereitstellungsdienst zu verändern, sofern es nicht teil des Dienstes selbst ist. Auch der Status eines Gerätes wird in einem speziellen Speicher erfasst. Zu dem Status gehören nicht nur Informationen wie Online oder Offline sondern auch die Art der Kommunikation.  


Ist ein Gerät zugelassen kann es über das Gateway der Cloud Daten zu einem Stream Prozessor schicken. Dieser übernimmt die Aufgaben der Analyse der Daten. Ein Stream Prozessor kann dabei mehrere Datenströme verwalten oder ein Datenstrom kann auf mehrere Stream Prozessoren aufgeteilt werden. Dies hängt von der Komplexität des Datenstroms ab. So kann ein Stream Prozessor nur auf spezielle Arten von Ereignissen hören, während ein anderer eine komplexe Ereignisverarbeitung parallel durchführen kann. Diese Prozessoren können den Pfad von Daten und Routen ohne Umformung oder komplexe Ereignisverarbeitungsaufgaben wie Datenaggregation, Datenanreicherung durch Korrelation mit Referenzdaten sowie analytische Aufgaben wie Erkennung von Grenzwerten oder Anomalien und Erstellung von Alarmen ermitteln. Modelle für Stream Prozessoren können Raw telemetry, Bulk upload, Device state, Device metadata, Special events, Diagnostics telemetry, Hot path analytics oder Machine learning sein. 


Für das Durchführen einer modellbasierten Analyse ist dann ein weiteres Modul zuständig. Dieses Modul hat die Möglichkeit Daten an den Stream Prozessor nach Verarbeitung zurück zu geben oder direkt zu speichern. So kann ein Sensordatenstrom mithilfe von Diagnosewerkzeugen zusammengefasst oder verkleinert werden und ein neuer Stream Prozessor entscheidet dann, ob weitere Schritte notwendig sind. 


Ein App-Backend (Geschäftslogik) sorgt für die Verwaltung aller Module und die Weitergabe der Daten an eine Solution UX oder einen Business Integration Connector. Die Solution UserExperience bietet dabei viele Möglichkeiten an. So kann eine Visualisierung der Daten über ein Webinterface, eine Mobile App oder ein Desktopprogramm erfolgen oder die Daten werden über eine API herausgegeben. Zusätzlich wird die Möglichkeit für eine Interaktion mit dem System geboten. Es kann zum Beispiel Einfluss auf einen Stream Prozessor genommen werden, wie z.B. das Ändern von Temperaturschwellwerten für die Heizungssteuerung. 


Über den Business Integration Connector ist es möglich das gesamte IOT Hub in ein ERP, CRM oder LOB-System einzubetten. 


### Redundanz


Was passiert, wenn das Speichern von Daten fehlschlägt oder ein kompletter Speicherknoten ausfällt? Mit dieser Frage beschäftigt sich die Redundanz in der Datenhaltung des IOT Hubs. Ein großer Vorteil ist jedoch, dass es nicht mehr nötig ist alles zu implementieren, denn der Cloud-Dienst übernimmt dies mithilfe von einfachen Konfigurationen. Dabei werden die  Systeme Locally Redundant Storage (LRS), Geo-Redundant Storage (GRS), Read-Access Geo-Redundant Storage (RA GRS) und Zone-Redundant Storage angeboten. Das LRS sorgt dafür, dass zunächst mindestens drei Kopien eines Speicherkontens erstellt werden, bevor das Schreiben zugelassen wird. Ist das Speichern in einem Knoten erfolgreich gewesen, wird dies für alle anderen wiederholt. Das Bedeutet, dass alle Kopien immer synchron sind. GRS beginnt wie LRS, es werden zunächst mindestens drei Kopien der aktuellen Knoten erstellt mit dem Unterschied, dass alle Knoten asynchron an einem geografisch anderen Standort gespiegelt werden. RA GRS erweitert GRS um die Möglichkeit die Geografisch entfernten Daten zu lesen. Dies ermöglicht dem Kunden eine bessere Überwachung der Daten. 


### Sicherheit


Das IOT Hub bietet viele Möglichkeiten für die Sicherheit. Die Datensicherung geschieht durch Role-Based Access Control (RBAC) und Microsoft Azure Active Directory (Azure AD). Durch Rollen sollen Daten nicht für jeden sichtbar gemacht werden. Für die Übermittlung der Daten werden Protokolle wie HTTPs oder SMB verwendet. Shared access signature (SAS) bietet die Möglichkeit alle Daten, Datenbanken oder ganze Laufwerke mit asynchronen Verfahren zu verschlüsseln. Auch eine Storage Service Encryption (SSE) kann verwendet werden, wenn die Daten zusätzlich Serverintern verschlüsselt werden sollen. 
